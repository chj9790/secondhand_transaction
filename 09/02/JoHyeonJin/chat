<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>마이페이지 - 채팅</title>
    
    <style>
        #chat_modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        #chat_room {
            background-color: white;
            margin: 8% auto;
            padding: 30px;
            border-radius: 16px;
            width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .close_btn {
            position: absolute;
            top: 16px;
            right: 20px;
            font-size: 24px;
            color: #999;
            cursor: pointer;
        }

        .close_btn:hover {
            color: #ff4d4f;
        }

        .chat-msg {
            margin: 5px 0;
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 70%;
            clear: both;
        }

        .chat-msg.me {
            background-color: #dcf8c6;
            float: right;
            text-align: right;
        }

        .chat-msg.other {
            background-color: #f1f0f0;
            float: left;
            text-align: left;
        }

        .chat-meta {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }

        #chat_window::after {
            content: "";
            display: block;
            clear: both;
        }
        
        .close_chatRoom_btn {
		    position: absolute;
		    top: 8px;
		    right: 8px;
		    font-size: 18px;
		    color: #999;
		    cursor: pointer;
		}
		
		.close_chatRoom_btn:hover {
		    color: #ff4d4f;
		}
        
    </style>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let socket;

        function openChatModal(seller_id, buyer_id, product_num) {
            document.getElementById("chat_buyer_id").innerText = buyer_id;
            document.getElementById("chat_modal").style.display = "block";

            function formatDateTime(dateStr) {
                const date = new Date(dateStr);
                const yyyy = date.getFullYear();
                const MM = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                const HH = String(date.getHours()).padStart(2, '0');
                const mm = String(date.getMinutes()).padStart(2, '0');
                return yyyy + "-" + MM + "-" + dd + " " + HH + ":" + mm;
            }

            $.ajax({
                url: "/chat/history",
                method: "GET",
                data: {
                    buyer_id: buyer_id,
                    seller_id: seller_id,
                    product_num: product_num
                },
                success: function(messages) {
                    const chatWindow = document.getElementById("chat_window");
                    chatWindow.innerHTML = "";
                    messages.forEach(function(msg) {
                        const isMe = msg.from_user === seller_id;
                        const formattedTime = formatDateTime(msg.sent_time);

                        let messageHtml = "<div class='chat-msg " + (isMe ? "me" : "other") + "'>";
    	                messageHtml += "<div>" + (isMe ? "" : "<b>" + msg.from_user + ":</b> ") + msg.message + "</div>";
    	                messageHtml += "<div class='chat-meta'>" + formattedTime;
    	                if (isMe && msg.is_read == 1) {
    	                    messageHtml += " · 읽음";
    	                }
    	                messageHtml += "</div></div>";
                        
                        chatWindow.innerHTML += messageHtml;
                    });
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                    
    	            if (socket && socket.readyState === WebSocket.OPEN) {
    	                const readPayload = {
    	                    type: "read",
    	                    opponentId: buyer_id,
    	                    productNum: product_num
    	                };
    	                socket.send(JSON.stringify(readPayload));
    	            }
                }
            });

            if (!socket || socket.readyState !== WebSocket.OPEN) {
	            socket = new WebSocket("ws://localhost:8282/chat/" + seller_id);
	
	            socket.onmessage = (event) => {
	                const data = JSON.parse(event.data);
	                
	                if (data.type === "chat") {
	                	const chatWindow = document.getElementById("chat_window");
	                	const now = formatDateTime(new Date());
		                chatWindow.innerHTML += "<div class='chat-msg other'><div><b>" + data.from + ":</b> " + data.message + "</div><div class='chat-meta'>" + now + "</div></div>";
		                chatWindow.scrollTop = chatWindow.scrollHeight;	
	                } else if (data.type === "read_ack") {
		                $('#chat_window .chat-msg.me .chat-meta').each(function() {
		                    if (!$(this).text().includes('읽음')) {
		                        $(this).append(' · 읽음');
		                    }
		                });
		            }
	            };
            }

            document.getElementById('send_btn').onclick = () => {
                const input = document.getElementById('chat_input');
                const message = input.value;
                if (message && socket && socket.readyState === WebSocket.OPEN) {
                    const payload = {
                        type: "chat",
                        from: seller_id,
                        to: buyer_id,
                        message: message,
                        product_num: product_num
                    };
                    socket.send(JSON.stringify(payload));

                    const chatWindow = document.getElementById("chat_window");
                    const now = formatDateTime(new Date());
                    chatWindow.innerHTML += "<div class='chat-msg me'><div>" + message + "</div><div class='chat-meta'>" + now + "</div></div>";
                    chatWindow.scrollTop = chatWindow.scrollHeight;

                    input.value = "";
                }
            };
            
            document.getElementById("chat_input").addEventListener("keydown", function(event) {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    document.getElementById("send_btn").click();
                }
            });
        }

        function closeChatModal() {
            document.getElementById("chat_modal").style.display = "none";
            if (socket) {
                socket.close();
                socket = null;
            }
        }

        $(document).on("click", ".chat-btn", function() {
            const buyer_id = $(this).data("buyerId");
            const seller_id = $(this).data("sellerId");
            const product_num = $(this).data("productNum");
            openChatModal(seller_id, buyer_id, product_num);
        });
    </script>
</head>
<body>

    <jsp:include page="include/header.jsp" />

    <c:if test="${empty groupedChatList}">
        <p align="center">수신한 채팅이 없습니다.</p>
    </c:if>

    <c:forEach var="productEntry" items="${groupedChatList}">
	    <c:set var="productNum" value="${productEntry.key}" />
	    <div style="max-width: 1000px; margin: 30px auto; padding: 15px; border: 1px solid #ccc;">
	    	<div style="text-align: center;">
	    		<h2>채팅 메시지 목록</h2><hr style="border: none; border-top: 1px solid #ccc; margin: 30px 0;">
	    	</div>
	    	<c:forEach var="productDTO" items="${product_list }">
	    		<c:if test="${productDTO.product_num eq productNum}">
	    			<h3>판매글 : ${productDTO.product_title}</h3>	
	    		</c:if>
	    	</c:forEach>
	        
	        <c:forEach var="chatRoomEntry" items="${productEntry.value}">
			    <c:set var="chatRoomNum" value="${chatRoomEntry.key}" />
			    <c:set var="chatList" value="${chatRoomEntry.value}" />
				<c:set var="buyerId" value="" />
				<c:forEach var="chat" items="${chatList}">
				    <c:if test="${buyerId == ''}">
				        <c:choose>
				            <c:when test="${chat.from_user ne sessionScope.user.user_id}">
				                <c:set var="buyerId" value="${chat.from_user}" />
				            </c:when>
				            <c:when test="${chat.to_user ne sessionScope.user.user_id}">
				                <c:set var="buyerId" value="${chat.to_user}" />
				            </c:when>
				        </c:choose>
				    </c:if>
				</c:forEach>
				
				<div style="margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; position: relative;">
					<div class="close_chatRoom_btn" onclick="if(confirm('해당 채팅방을 나가시겠습니까?\n채팅방을 나가면 이전 채팅 기록은 모두 삭제됩니다.')) { location.href='out_chat_room.go?chat_room_num=${chatRoomNum}&user_id=${sessionScope.user.user_id}'; } else { return false; }">
						&times;
					</div>
				
			        <p><b>상대방 : </b>${buyerId}</p>
			        <p><b>마지막 메세지 : </b> 
			            <c:forEach var="productDTO" items="${product_list }">
			                <c:if test="${productDTO.product_num eq productNum}">
			                    <c:forEach var="chat" items="${chatList}" varStatus="status">
			                    	<c:if test="${status.last}">
								        ${chat.message}
								    </c:if>
			                    </c:forEach>
			                </c:if>
			            </c:forEach>
			        </p>
			
			        <button class="chat-btn"
			                data-buyer-id="${buyerId}"
			                data-seller-id="${sessionScope.user.user_id}"
			                data-product-num="${productNum}">
			            채팅하기
			        </button>
			    </div>
			    
			</c:forEach>

	    </div>
	</c:forEach>

    <!-- 모달 채팅창 -->
    <div id="chat_modal">
        <div id="chat_room">
            <div class="close_btn" onclick="closeChatModal()">&times;</div>
            <p id="chat_header"><b>상대방 :</b> <span id="chat_buyer_id"></span></p>
            <div id="chat_window" style="height:200px; overflow:auto; border:1px solid #ccc; padding:10px; margin-bottom:10px;"></div>
            <input type="text" id="chat_input" placeholder="메시지를 입력하세요" style="width:85%;">
            <button id="send_btn">보내기</button>
        </div>
    </div>

    <jsp:include page="include/footer.jsp" />
</body>
</html>
