<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
    
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<style type="text/css">

/* ===== 기본 테이블 ===== */
.tbl table {
    border-collapse: collapse;
    border-color: #ddd;
    width: 80%;
    max-width: 1000px;
    margin: 30px auto;
    background: #fff;
}
.tbl th {
    background-color: #E6F0FF;
    color: #2b7cff;
    padding: 12px;
    font-size: 18px;
}
.tbl td {
    padding: 15px;
    border: 1px solid #ddd;
    text-align: center;
    vertical-align: middle;
}
.product-info {
    text-align: left;
    font-size: 14px;
}
.info-span {
    display: block;
    margin: 5px 0;
}
.product-btn {
	cursor: pointer;
}

/* ===== 페이징 ===== */
.pagination-wrapper {
    margin: 30px 0;
}

.pagination {
    display: inline-flex;
    gap: 6px;
    padding: 10px 20px;
    border-radius: 12px;
    background-color: #f2f7fd;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.page-btn {
    display: inline-block;
    padding: 8px 14px;
    font-size: 14px;
    font-weight: 500;
    color: #2b7cff;
    background-color: white;
    border: 1px solid #b3d3ff;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s ease;
}

.page-btn:hover {
    background-color: #dceaff;
}

.page-btn.active {
    background-color: #2b7cff;
    color: white;
    border-color: #2b7cff;
}

.page-btn.first,
.page-btn.last {
    font-weight: bold;
}

/* ===== 판매 상태 색상 ===== */
.status-blue {
    color: #3498db;
    font-weight: bold;
}
.status-red {
    color: #e74c3c;
    font-weight: bold;
}
.status-gray {
    color: #7f8c8d;
    font-weight: bold;
}

/* ===== 모달 wrapper ===== */
#product_modal,
#product_modify_modal {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background-color: rgba(0,0,0,0.5);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
}

/* ===== 모달 콘텐츠 ===== */
.modal-content {
    background: #fff;
    padding: 30px;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    animation: fadeIn 0.3s ease-in-out;
    position: relative;
}

/* ===== 모달 애니메이션 ===== */
@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}

/* ===== 닫기 버튼 ===== */
.close_btn {
    position: absolute;
    top: 12px;
    right: 20px;
    font-size: 28px;
    font-weight: bold;
    color: #999;
    cursor: pointer;
    transition: color 0.2s;
}
.close_btn:hover {
    color: #e74c3c;
}

/* ===== 모달 내부 구조 ===== */
.modal-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.modal-header h2 {
    margin: 0;
    font-size: 22px;
    color: #2c3e50;
    border-bottom: 1px solid #eee;
    padding-bottom: 12px;
}

.product-detail-layout {
    display: flex;
    flex-wrap: wrap;
    gap: 30px;
}

/* ===== 이미지 영역 (최대 3개까지) ===== */
.image-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    flex: 1 1 100%;
}
.image-cell {
    flex: 1 1 calc(33.33% - 12px);
    max-width: calc(20% - 12px);
}
.product-img-preview {
    width: 100%;
    height: auto;
    object-fit: cover;
    border: 1px solid #ccc;
    border-radius: 6px;
}

/* ===== 상품 정보 영역 ===== */
.info-sections {
    flex: 1 1 100%;
    display: flex;
    flex-direction: column;
    gap: 16px;
}
.info-section {
    background-color: #f9fbfd;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.info-section h3 {
    margin-top: 0;
    margin-bottom: 10px;
    font-size: 16px;
    color: #333;
    border-bottom: 1px solid #ddd;
    padding-bottom: 6px;
}
.info-section p {
    margin: 6px 0;
    font-size: 14px;
}
.description-text {
    white-space: pre-wrap;
    line-height: 1.6;
    color: #444;
}

/* ===== 모달 버튼 ===== */
.modal-footer {
    text-align: right;
}
.modal-footer button {
    padding: 8px 16px;
    background-color: #2b7cff;
    color: white;
    border: none;
    border-radius: 6px;
    margin-left: 10px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s;
}
.modal-footer button:hover {
    background-color: #155ecf;
}

/* ===== 무료나눔 안내 ===== */
.mod-img-guide {
    font-size: 12px;
    color: #888;
    display: block;
    margin-top: 8px;
}

/* ===== 반응형 ===== */
@media (max-width: 768px) {
    .product-detail-layout {
        flex-direction: column;
    }
    .image-cell {
        flex: 1 1 100%;
        max-width: 100%;
    }
}

#product_modify_modal.modal-wrapper {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background-color: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1050;
}

#product_modify_modal .modal-content {
  background: white;
  border-radius: 12px;
  max-width: 900px;
  width: 90%;
  max-height: 90vh;
  padding: 30px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  overflow-y: auto;
  position: relative;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

#product_modify_modal .modal-header {
  margin: 0 0 15px 0;
  font-size: 22px;
  border-bottom: 1px solid #eee;
  padding-bottom: 10px;
  color: #2c3e50;
}

#product_modify_modal table.modal-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

#product_modify_modal table.modal-table td {
  padding: 10px 8px;
  vertical-align: top;
}

#product_modify_modal input[type="text"], 
#product_modify_modal textarea {
  display: inline-block;  /* 혹은 inline */
  vertical-align: middle;
  width: 90%; /* 원하는 크기 */
  padding: 6px 8px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-family: inherit;
  resize: vertical;
}

.title-input input[type="text"] {
	width: 92% !important;
}

#product_modify_modal .image-preview-wrapper {
  display: flex;
  gap: 10px;
}

#product_modify_modal .product-img-preview {
  width: 130px;
  height: 130px;
  object-fit: cover;
  border-radius: 6px;
  border: 1px solid #ccc;
}

#product_modify_modal .mod-img-guide {
  font-size: 12px;
  color: #666;
  margin-top: 8px;
  display: block;
}

#product_modify_modal .button-area {
  text-align: right;
}

#product_modify_modal button.btn-submit {
  background-color: #2b7cff;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  cursor: pointer;
  font-size: 14px;
  margin-left: 10px;
  transition: background-color 0.2s ease;
}

#product_modify_modal button.btn-submit:hover {
  background-color: #155ecf;
}

#product_modify_modal button.btn-cancel {
  background-color: #aaa;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  font-size: 14px;
  cursor: pointer;
  transition: background-color 0.2s ease;
  margin-left: 10px;
}

#product_modify_modal button.btn-cancel:hover {
  background-color: #888;
}

#product_modify_modal .close_btn {
  position: absolute;
  right: 20px;
  top: 15px;
  font-size: 28px;
  cursor: pointer;
  color: #888;
  transition: color 0.3s;
}

#product_modify_modal .close_btn:hover {
  color: #e74c3c;
}

@media (max-width: 768px) {
  #product_modify_modal .image-preview-wrapper {
    flex-wrap: wrap;
    justify-content: flex-start;
  }
  #product_modify_modal .product-img-preview {
    width: 100px;
    height: 100px;
  }
}

</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
	
	const contextPath = "<%= request.getContextPath() %>/";
	
	$(document).ready(function() {
		
		$(".product-btn").click(function() {
			const product_num = $(this).data("productNum");
			const category_code = $(this).data("categoryCode");
			const product_name = $(this).data("productName");
			const product_date = $(this).data("productDate");
			const product_img = $(this).data("productImg");
			const product_des = $(this).data("productDes");
			const sales_price = $(this).data("salesPrice");
			const product_title = $(this).data("productTitle");
			const product_hits = $(this).data("productHits");
			const product_status = $(this).data("productStatus");
			const category_name = $(this).data("categoryName");
			
			const formatted_price = Number(sales_price).toLocaleString();
			
			let p_html = "";

			p_html += "<div class='modal-container'>";
			p_html += "  <div class='modal-header'>";
			p_html += "    <h2>나의 판매글 상세 보기</h2>";
			p_html += "    <span class='close_btn' onclick='closeProductModal()'>&times;</span>";
			p_html += "  </div>";

			p_html += "  <div class='modal-body'>";

			// 상품 레이아웃 시작
			p_html += "    <div class='product-detail-layout'>";

			// 이미지 영역
			p_html += "      <div class='image-grid'>";
			let imgArr = product_img.split(",");
			for (let img of imgArr) {
			    p_html += "<div class='image-cell'>";
			    p_html += "  <img src='" + contextPath + "resources/upload/" + img.trim() + "' class='product-img-preview'>";
			    p_html += "</div>";
			}
			p_html += "      </div>";

			// 정보 영역
			p_html += "      <div class='info-sections'>";

			// 기본 정보
			p_html += "        <div class='info-section'>";
			p_html += "          <h3>기본 정보</h3>";
			p_html += "          <p><strong>제목:</strong> " + product_title + "</p>";
			p_html += "          <p><strong>물품명:</strong> " + product_name + "</p>";
			p_html += "          <p><strong>카테고리:</strong> " + category_name + "</p>";
			p_html += "          <p><strong>판매상태:</strong> " + product_status + "</p>";
			p_html += "        </div>";

			// 게시 정보
			p_html += "        <div class='info-section'>";
			p_html += "          <h3>게시 정보</h3>";
			p_html += "          <p><strong>등록일:</strong> " + product_date + "</p>";
			p_html += "          <p><strong>조회수:</strong> " + product_hits + "</p>";
			p_html += "        </div>";

			// 가격
			p_html += "        <div class='info-section'>";
			p_html += "          <h3>가격</h3>";
			p_html += "          <p>" + (formatted_price == 0 ? "무료나눔" : formatted_price + " 원") + "</p>";
			p_html += "        </div>";

			p_html += "      </div>"; // .info-sections

			p_html += "    </div>"; // .product-detail-layout

			// 설명
			p_html += "    <div class='info-section'>";
			p_html += "      <h3>상품 설명</h3>";
			p_html += "      <p class='description-text'>" + product_des + "</p>";
			p_html += "    </div>";

			p_html += "  </div>"; // modal-body

			// 버튼
			p_html += "  <div class='modal-footer'>";
			p_html += "    <button onclick=\"productModify('" + product_num + "', '" + product_title + "', '" + product_name + "', '" + category_name + "', '" + product_des + "', '" + product_img + "', '" + sales_price + "')\">수정</button>";
			p_html += "    <button onclick=\"if(confirm('정말 삭제하시겠습니까?')) location.href='user_product_delete.go?product_num=" + product_num + "'\">삭제</button>";
			p_html += "  </div>";

			p_html += "</div>";

			document.getElementById("product_content").innerHTML = p_html;
			document.getElementById("product_modal").style.display = "flex";
		});
		
	});
	
	
	function productModify(product_num, product_title, product_name, category_name, product_des, product_img, sales_price) {
		
		$(document).ready(function() {
			
			$("#free").on("change", function () {
	            if($(this).is(":checked")) {
	                $("input[name='sales_price']").val("0").prop("readonly", true);
	            } else {
	                $("input[name='sales_price']").val("").prop("readonly", false);
	            }
	        });
			
		});
		
		let modify_html = "<div id='product_modify_modal' class='modal-wrapper'>";
		modify_html += "<div class='modal-content'>";
		modify_html += "<h2 class='modal-header'>물품 판매글 수정</h2>";

		modify_html += "<form id='mod_form' method='post' action='user_product_modify.go'>";
		modify_html += "<input type='hidden' name='product_num' value='" + product_num + "'>";

		modify_html += "<table class='modal-table'>";
		modify_html += "<tr>";
		modify_html += "<td colspan='2'><b>판매글 제목 </b>";
		modify_html += "</td>";
		modify_html += "</tr>";
		
		modify_html += "<tr>";
		modify_html += "<td class='title-input' colspan='2'>";
		modify_html += "<input type='text' name='product_title' value='" + product_title + "'>";
		modify_html += "</td>";
		modify_html += "</tr>";

		modify_html += "<tr>";
		modify_html += "<td width='20%'><b>카테고리</b>";
		modify_html += "</td>";
		modify_html += "<td><b>물품명 </b>";
		modify_html += "</td>";
		modify_html += "</tr>";
		
		modify_html += "<tr>";
		modify_html += "<td width='20%'>";
		modify_html += "<input type='text' value='" + category_name + "' readonly>";
		modify_html += "</td>";
		modify_html += "<td>";
		modify_html += "<input type='text' name='product_name' value='" + product_name + "'>";
		modify_html += "</td>";
		modify_html += "</tr>";

		modify_html += "<tr>";
		modify_html += "<td><b>물품 설명</b></td>";
		modify_html += "<td colspan='2'>";
		modify_html += "<textarea name='product_des' rows='5' cols='30'>" + product_des + "</textarea>";
		modify_html += "</td>";
		modify_html += "</tr>";

		modify_html += "<tr>";
		modify_html += "<td><b>물품 사진</b></td>";
		modify_html += "<td colspan='2'>";
		modify_html += "<div class='image-preview-wrapper'>";
		const imgArr = product_img.split(",");
		for (let i = 0; i < imgArr.length && i < 3; i++) {
		  let img = imgArr[i].trim();
		  modify_html += "<img src='" + contextPath + "resources/upload/" + img + "' class='product-img-preview'>";
		}
		modify_html += "</div>";
		modify_html += "<br><span class='mod-img-guide'>※사진 수정을 원하시면 판매 글 삭제 후 다시 등록해주세요.</span>";
		modify_html += "</td>";
		modify_html += "</tr>";

		modify_html += "<tr>";
		modify_html += "<td><b>판매 가격</b><br><br></td>";
		modify_html += "<td><input type='text' name='sales_price' value='" + sales_price + "'> 원</td>";
		modify_html += "</tr>";
		
		modify_html += "<tr>";
		modify_html += "<td class='free-box' colspan='2'>"
		modify_html += "<div style='float: right; margin-right: 3%;'><input type='checkbox' id='free'>무료나눔</div>" 
		modify_html += "</td>";
		modify_html += "</tr>";
			
		modify_html += "</table>";

		modify_html += "<div class='button-area'>";
		modify_html += "<button type='submit' class='btn-submit'>수정완료</button>";
		modify_html += "<button type='button' class='btn-cancel' onclick='closeProductModifyModal()'>취소</button>";
		modify_html += "</div>";
		modify_html += "</form>";

		modify_html += "<div class='close_btn' onclick='closeProductModifyModal()'>&times;</div>";
		modify_html += "</div>"; // modal-content
		modify_html += "</div>"; // modal-wrapper

		
		document.getElementById("product_modify").innerHTML = modify_html;
		
		closeProductModal();
		document.getElementById("product_modify_modal").style.display = "flex";
		
	}
	
	function closeProductModal() {
		document.getElementById("product_modal").style.display = "none";
	}
	
	function closeProductModifyModal() {
		document.getElementById("product_modify_modal").style.display = "none";
	}
	
	
	
</script>

<title>Insert title here</title>
</head>
<body>

	<div class="main-bar">
		<jsp:include page="include/header.jsp" />
	</div>
	
	<div>
		<c:set var="user_sales_list" value="${user_product_list}"/>
		<c:set var="category_list" value="${category_list }"/>
		
		<div class="tbl" align="center">
			<table border="1">
				<tr>
					<th colspan="3">등록된 판매 글</th>
				</tr>
				
				<c:if test="${empty user_sales_list }">
				
					<tr>
						<td colspan="3">등록된 판매 글이 존재하지 않습니다.</td>
					</tr>
				
				</c:if>
				
				<c:forEach var="user_sales_product" items="${user_sales_list}">
					<c:set var="imgList" value="${fn:split(user_sales_product.product_img, ',')}" />
					
					<c:forEach var="categoryDTO" items="${category_list }">
						<c:if test="${categoryDTO.category_code == user_sales_product.category_code }">
							<tr class="product-btn" data-product-num="${user_sales_product.product_num }"
												data-category-code="${user_sales_product.category_code }"
												data-product-name="${user_sales_product.product_name }"
												data-product-date="<fmt:formatDate value='${user_sales_product.product_date}' pattern='yyyy-MM-dd'/>"
												data-product-img="${user_sales_product.product_img }"
												data-product-des="${user_sales_product.product_des }"
												data-sales-price="${user_sales_product.sales_price }"
												data-product-title="${user_sales_product.product_title }"
												data-product-hits="${user_sales_product.product_hits }"
												data-product-status="${user_sales_product.product_status }"
												data-category-name="${categoryDTO.category_name }"
							>
								<td width="20%">
									<img src="<%=request.getContextPath() %>resources/upload/${imgList[0]}" width="80" height="80">
								</td>
								
								<td width="30%">
									<b>${user_sales_product.product_title }</b><br><br>
									<b>판매물품 : </b>${user_sales_product.product_name }
								</td>
								
								<td class="product-info" width="50%">
									<span class="info-span"><b>등록일 : </b><fmt:formatDate value="${user_sales_product.product_date }" /></span>
									<span class="info-span"><b>판매상태 : </b>
										<c:if test="${user_sales_product.product_status == '판매중'}">
											<span class="status-blue">${user_sales_product.product_status }</span>
										</c:if>
										
										<c:if test="${user_sales_product.product_status == '예약중'}">
											<span class="status-red">${user_sales_product.product_status }</span>
										</c:if>
										
										<c:if test="${user_sales_product.product_status == '판매완료'}">
											<span class="status-gray">${user_sales_product.product_status }</span>
										</c:if>
									</span>
									<b>조회수 : </b>${user_sales_product.product_hits }
								</td>
							</tr>
						</c:if>
					</c:forEach>
					
				</c:forEach>
			
			</table>
		</div>
		
		<div class="pagination-wrapper" align="center">
		        <div class="pagination">
		            <c:if test="${paging.page > paging.block}">
		                <a href="user_sales_product_list.go?page=1" class="page-btn first">처음</a>
		                <a href="user_sales_product_list.go?page=${paging.startBlock - 1}" class="page-btn">◀</a>
		            </c:if>
		
		            <c:forEach begin="${paging.startBlock}" end="${paging.endBlock}" var="i">
		                <c:choose>
		                    <c:when test="${i == paging.page}">
		                        <a href="user_sales_product_list.go?page=${i}" class="page-btn active">${i}</a>
		                    </c:when>
		             
		                    <c:otherwise>
		                        <a href="user_sales_product_list.go?page=${i}" class="page-btn">${i}</a>
		                    </c:otherwise>
		                </c:choose>
		            </c:forEach>
		
		            <c:if test="${paging.endBlock < paging.allPage}">
		                <a href="user_sales_product_list.go?page=${paging.endBlock + 1}" class="page-btn">▶</a>
		                <a href="user_sales_product_list.go?page=${paging.allPage}" class="page-btn last">마지막</a>
		            </c:if>
		        </div>
		    </div>
		
	</div>
	
	<div id="product_modal" class="modal-wrapper" style="display : none;">
	    <div id="product_content" class="modal-content"></div>
	</div>
	
	<div id="product_modify_modal" class="modal-wrapper" style="display : none;">
	    <div id="product_modify" class="modal-content"></div>
	</div>
	
	<jsp:include page="include/footer.jsp" />
	
</body>
</html>
