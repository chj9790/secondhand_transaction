#### header ####

<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>

<!DOCTYPE html>

<meta charset="UTF-8">
<title>중고 거래 사이트</title>
<style>
    .header {
	    margin: 0;
	    padding: 16px 40px;
	    background-color: #ffffff;
	    border-bottom: 1px solid #e0e0e0;
	    display: flex;
	    justify-content: space-between;
	    align-items: center;
	    font-family: 'Segoe UI', sans-serif;
	    position: sticky;
	    top: 0;
	    z-index: 1000;
	}
	
	.header-title h1 {
	    font-size: 35px;
	    color: #2b7cff;
	    margin: 0;
	    cursor: pointer;
	    transition: 0.3s ease;
	}
	
	.header-title h1:hover {
	    opacity: 0.8;
	}
	
	.main-btn {
	    display: flex;
	    gap: 12px;
	    flex-wrap: wrap; /* 모바일 대응 */
	}
	
	.main-btn button {
	    background-color: transparent;
	    border: 1px solid #2b7cff;
	    padding: 7px 16px;
	    border-radius: 6px;
	    font-size: 14px;
	    color: #2b7cff;
	    font-weight: 500;
	    cursor: pointer;
	    transition: all 0.25s ease;
	}
	
	.main-btn button:hover {
	    background-color: #2b7cff;
	    color: white;
	}
	
	/* 로그인 관련 */
	.login-area {
	    display: flex;
	    gap: 10px;
	    align-items: center;
	}
	
	.login-input input[type="text"],
	.login-input input[type="password"] {
	    padding: 7px 10px;
	    font-size: 14px;
	    border: 1px solid #ccc;
	    border-radius: 6px;
	}
	
	.login-buttons button {
	    background-color: transparent;
	    border: 1px solid #2b7cff;
	    padding: 7px 16px;
	    border-radius: 6px;
	    font-size: 14px;
	    color: #2b7cff;
	    font-weight: 500;
	    cursor: pointer;
	    transition: all 0.25s ease;
	}
	
	.login-buttons button:hover {
	    background-color: #2b7cff;
	    color: white;
	}
	
	/* 반응형 */
	@media screen and (max-width: 768px) {
	    .header {
	        flex-direction: column;
	        align-items: flex-start;
	        gap: 12px;
	        padding: 20px;
	    }
	
	    .header-title h1 {
	        font-size: 24px;
	    }
	
	    .main-btn {
	        flex-wrap: wrap;
	    }
	}
    
</style>


    <div class="header">
        <div class="header-title">
            <h1 onclick="location.href='/'">중고마켓</h1>
        </div>
        <div id="user-location" style="font-weight: bold; margin: 10px 20px;"></div>
        
        <c:choose>
	        <c:when test="${not empty sessionScope.user}">
	            <div class="main-btn">	            	
            		<button onclick="location.href='product_sales.go'">물품 판매</button>
                	<button onclick="location.href='user_my_page.go'">마이페이지</button>	            		                
	                <button onclick="location.href='logout.go'">로그아웃</button>
	            </div>
	        </c:when>
	        <c:otherwise>
	            <div class="login-area">
	                       
	                <form method="post" action="login.go" style="display: flex; gap: 10px; align-items: center;">
	                    <div class="login-input">
	                        <input type="text" name="userId" placeholder="아이디" required />
	                        <input type="password" name="userPwd" placeholder="비밀번호" required />
	                    </div>
	                    <div class="login-buttons">
	                        <button type="submit">로그인</button>
	                        <button type="button" onclick="location.href='sign_up.go'">회원가입</button>
	                    </div>
	                </form>
	            </div>
	        </c:otherwise>
	    </c:choose>
    </div>
    
     <script>
     
        function initMap() {
            console.log("Google Maps API loaded.");

            const locDiv = document.getElementById("user-location");
            console.log("locationEl (at initMap start):", locDiv); // initMap 시작 시 요소 확인

            if (locDiv) {
                locDiv.textContent = "현재 위치: 위치 정보를 가져오는 중..."; // 로딩 메시지
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;
                        console.log("위치 정보:", lat, lng);
                        getAddressFromCoords(lat, lng);
                    },
                    err => {
                        console.error("위치 접근 실패:", err.message);
                        if (locDiv) {
                            locDiv.textContent = `위치 정보 접근 실패: ${err.message}`;
                            if (err.code === err.PERMISSION_DENIED) {
                                locDiv.textContent = "위치 정보 접근이 거부되었습니다. 브라우저 설정에서 위치 권한을 허용해주세요.";
                            }
                        }
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 } // 위치 옵션 추가
                );
            } else {
                if (locDiv) {
                    locDiv.textContent = "현재 브라우저에서 위치 정보 기능을 지원하지 않습니다.";
                }
            }
        }

        function getAddressFromCoords(lat, lng) {
            const geocoder = new google.maps.Geocoder();
            const latlng = { lat: parseFloat(lat), lng: parseFloat(lng) };
            const locationEl = document.getElementById("user-location");

            geocoder.geocode({ location: latlng }, (results, status) => {
                if (status === "OK" && results.length > 5) {
                    let fullAddress = results[5].formatted_address;
                    
                    fullAddress = fullAddress.replace('대한민국 ', '');

                    fullAddress = fullAddress.replace(/\d(?!가)/g, '');

                    if (locationEl) {
                        locationEl.innerHTML = "현재 위치: <strong>" + fullAddress + "</strong>";
                    }

                    window.userLocationFullAddress = fullAddress;

                    const inputEl = document.getElementById("sales_area_input");
                    if (inputEl) {
                        inputEl.value = fullAddress;
                    }

                } else {
                    console.error("Geocoder failed:", status);
                }
            });
        }



        // 위치 텍스트가 "현재 위치: 경기도 고양시 일산동구 정발산동" 형식일 때
        function getUserLocationText() {
          const locEl = document.getElementById('user-location');
          if (!locEl) return null;
          const text = locEl.textContent || locEl.innerText || "";
          // "현재 위치: " 이후 문자열만 추출
          const prefix = "현재 위치: ";
          if (text.startsWith(prefix)) {
        	return text.substring(prefix.length).trim();
          }
          return null;
        }
        // 전역변수로 노출
        window.userLocationFullAddress = getUserLocationText();
      

    </script>

    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC6GZL5JoPGTDsQqjhGD-dgKj7hRQSTxfE&callback=initMap"
      async defer>
    </script>



    #### product_sales ####

    <%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
  
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style type="text/css">
    body {
        font-family: 'Segoe UI', sans-serif;
        background-color: #f4f7fb;
        margin: 0;
        padding: 0;
        color: #2a2a2a;
    }
    
    .main-bar {
	    background-color: white;
	    border-bottom: 1px solid #ddd;
	    padding: 16px 20px;
	}

    .body {
        max-width: 900px;
        margin: 40px auto;
        background-color: #ffffff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .tbl table {
        width: 100%;
        border-collapse: collapse;
        font-size: 15px;
    }

    .tbl th, .tbl td {
        padding: 12px 16px;
        border: 1px solid #d9d9d9;
        text-align: left;
    }

    .tbl th {
        background-color: #f0f4f9;
        width: 160px;
        font-weight: 600;
    }

    .tbl input[type="text"],
    .tbl input[type="file"],
    .tbl textarea,
    .tbl select {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        color: #2a2a2a;
        background-color: #fafcff;
        border: 1px solid #ccd9ee;
        border-radius: 6px;
        box-sizing: border-box;
        outline: none;
        transition: border 0.2s ease, box-shadow 0.2s ease;
        font-family: 'Segoe UI', sans-serif;
    }

    .tbl input:focus,
    .tbl textarea:focus,
    .tbl select:focus {
        border-color: #2b7cff;
        box-shadow: 0 0 0 3px rgba(43, 124, 255, 0.15);
    }

    .tbl textarea {
        resize: vertical;
        min-height: 100px;
    }

    .tbl input[type="file"] {
        background-color: #f8fafd;
        border: 1px dashed #bcd2f5;
        padding: 10px;
        cursor: pointer;
    }

    .tbl input::placeholder,
    .tbl textarea::placeholder {
        color: #aaa;
        font-style: italic;
    }

    .btn {
        margin-top: 30px;
        text-align: center;
    }

    .btn button {
        background-color: #e6f0ff;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        color: #2b7cff;
        cursor: pointer;
        margin: 0 12px;
        transition: background-color 0.2s ease;
    }

    .btn button:hover {
        background-color: #d0e4ff;
    }

    .sm-text {
        color: #888;
        font-size: 13px;
        margin-top: 6px;
        display: inline-block;
    }
</style>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript">

    $(document).ready(function() {
    	
    	if (window.userLocationFullAddress) {
            $('#sales_area_input').val(window.userLocationFullAddress);
        }
    	
        $("#upload").on("submit", function (e) {
            const files = $("input[name='product_img_File[]']")[0].files;

            if(files.length > 3) {
            	alert("사진은 최대 3개까지만 업로드할 수 있습니다.");
                e.preventDefault();
            }
            
            if(files.length < 1) {
            	alert("사진은 반드시 1장은 업로드 해야합니다.");
                e.preventDefault();
            }
            
            if($("select[name='category_code']").val() == 'none') {
            	alert("물품의 카테고리를 설정해주세요.");
                e.preventDefault();
            }
            
            if($("input[name='user_id']").val() == "" || $("input[name='sales_area']").val() == "") {
            	alert("세션이 만료되었습니다. 다시 로그인 해주세요.");
            	e.preventDefault();
            	location.href="/";
            }
            
        });
        
        $("#free").on("change", function () {
            if($(this).is(":checked")) {
                $("input[name='sales_price']").val("0").prop("readonly", true);
            } else {
                $("input[name='sales_price']").val("").prop("readonly", false);
            }
        });
     

    });
    
    
    
</script>

<title>Insert title here</title>
</head>
<body>
	
	<div class="main-bar">
		<jsp:include page="include/header.jsp" />
	</div>
	
	<div class="body" align="center">
		<c:set var="cList" value="${categoryList}" />
		<c:set var="userDTO" value="${sessionScope.user }" />
		
		<form id="upload" method="post" enctype="multipart/form-data"
			action="<%=request.getContextPath() %>/product_sales_ok.go">
		
			<div class="tbl">
				<input type="hidden" name="user_id" value="${userDTO.user_id }">
				<input type="hidden" name="sales_area" id="sales_area_input">
				
				<table border="1" width="800">
					<tr>
						<th>판매 글 제목</th>
						<td colspan="3"><input type="text" name="product_title" required></td>
					</tr>
				
					<tr>
						<th>물품 카테고리</th>
						<td>
							<select name="category_code">
								<option value="none">:::카테고리 선택:::</option>
								<c:forEach var="category_dto" items="${cList}">
									<option value="${category_dto.category_code }">${category_dto.category_name }</option>
								</c:forEach>
							</select>
						</td>
						
						<th>물품명</th>
						<td><input type="text" name="product_name" required></td>
					</tr>
					
					<tr>
						<th>물품 설명</th>
						<td colspan="3"><textarea rows="5" cols="30" name="product_des" required></textarea></td>
					</tr>
					
					<tr>
						<th>물품 이미지</th>
						<td colspan="3">
							<input type="file" name="product_img_File[]" multiple="multiple">
							<small class="sm-text">사진은 최대 3개까지만 업로드할 수 있습니다.</small>
						</td>
					</tr>
					
					<tr>
						<th>판매 가격</th>
						<td colspan="2"><input type="text" name="sales_price" required></td>
						<td><input type="checkbox" id="free">무료나눔</td>
					</tr>
				
				</table>
			</div>
			
			<div class="btn">
				<button type="submit">물품 등록</button>
				<button type="button" onclick="location.href='/'">등록 취소</button>
			</div>
		
		</form>
		
	</div>
	
	<jsp:include page="include/footer.jsp" />

</body>
</html>
