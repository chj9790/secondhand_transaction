<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>

<!DOCTYPE html>
<html>
<style>
/* --- 전체 공통 --- */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f9f9f9;
    margin: 0;
    padding: 0;
    color: #333;
}

h2, h3 {
    color: #2b7cff;
    margin-bottom: 10px;
}

p {
    margin: 5px 0;
}

/* --- 상품 상세 레이아웃 --- */
.product-container {
    display: flex;
    justify-content: center; /* 전체 가운데 정렬 */
    align-items: flex-start;
    gap: 40px;
    margin: 30px 0;
    flex-wrap: wrap;
}

.product-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* --- 상품 이미지 --- */
.product-img {
    width: 300px;           
    height: 300px;          
    object-fit: contain;    
    background-color: #fff; 
    border-radius: 8px;
    border: 1px solid #ddd;
    margin-bottom: 15px;
    display: block;         
}

/* --- 버튼 공통 --- */
button {
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    border-radius: 6px;
    padding: 6px 14px;
    border: 1px solid #2b7cff;
    background-color: transparent;
    color: #2b7cff;
    transition: all 0.25s ease;
}

button:hover {
    background-color: #2b7cff;
    color: white;
}

/* --- 채팅/신고 버튼 --- */
.chat-btn, .report-btn {
    display: inline-block;
    margin-right: 10px; /* 한 줄로 정렬 */
}

/* --- 댓글 제목(h3) --- */
.comment-title {
    text-align: left;
    margin-left: calc(50% - 550px);
    font-size: 18px;
    color: #2b7cff;
}

/* --- 댓글 폼 --- */
#commentForm {
    display: flex;
    gap: 10px;
    justify-content: center; /* 전체 가운데 정렬 */
    flex-wrap: wrap;
    margin-top: 10px;
}

#comment_content {
    width: 1000px;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
    resize: vertical;
}

#addCommentBtn {
    align-self: flex-end; 
}

/* --- 댓글 리스트 --- */
.comment-box {
    background-color: #f0f4ff; 
    padding: 12px 200px 12px 16px; 
    margin-bottom: 12px;
    border-radius: 8px;
    width: 1000px;
    position: relative;
    border: 1px solid #e0e0e0;
    box-sizing: border-box;
}

.comment-user {
    font-weight: bold;
    color: #2b7cff;
    margin-bottom: 4px;
}

.comment-content {
    font-size: 14px;
    color: #222;
    white-space: pre-wrap;
    display: flex;
    flex-direction: column; 
    gap: 5px; 
}

.comment-date {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
}

.comment-actions {
    position: absolute;
    top: 10px;
    right: 10px;
}

.comment-actions button {
    margin-left: 5px; 
    margin-right: 5px;
    font-size: 16px;
    padding: 2px 6px;
}

.comment-actions-inline {
    display: flex;
    justify-content: flex-end; 
    gap: 5px;                  
    margin-top: 5px;            
}
.comment-actions-inline button {
    font-size: 16px;
    padding: 2px 6px;
    margin-left: 5px;          
}

#commentList {
    display: flex;
    flex-direction: column;
    margin-top: 20px;
    margin-left: calc(50% - 560px);
}

.comment-wrapper {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 12px;
}

.edit-input {
    width: 900px;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
    resize: vertical;
}


.save-edit-btn,
.cancel-btn {
    align-self: flex-end;
    margin-left: 5px; 
}

/* --- 채팅/신고 모달 --- */
#chat_modal, #report_modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.6);
}

#chat_room, #report_table {
    background-color: white;
    margin: 6% auto;
    padding: 25px;
    border-radius: 16px;
    width: 500px;
    max-width: 90%;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    position: relative;
}

.close_btn {
    position: absolute;
    top: 16px;
    right: 20px;
    font-size: 24px;
    color: #999;
    cursor: pointer;
    z-index: 10;
}

.close_btn:hover {
    color: #ff4d4f;
}

/* --- 채팅 메시지 --- */
.chat-msg {
    margin: 5px 0;
    padding: 8px 12px;
    border-radius: 10px;
    max-width: 70%;
    clear: both;
}

.chat-msg.me {
    background-color: #dcf8c6;
    float: right;
    text-align: right;
}

.chat-msg.other {
    background-color: #f1f0f0;
    float: left;
    text-align: left;
}

.chat-meta {
    font-size: 11px;
    color: #888;
    margin-top: 4px;
}

#chat_window::after {
    content: "";
    display: block;
    clear: both;
}

/* --- 반응형 --- */
@media screen and (max-width: 768px) {
    .product-img {
        width: 100%;
        height: auto;
    }
    #chat_room, #report_table {
        width: 95%;
        padding: 20px;
    }
    #commentForm {
        width: 100%;
    }
    #comment_content {
        width: 100%;
    }
    .comment-box {
        width: 95%;
        padding-right: 40px;
    }
    .comment-title {
        margin-left: 0;
        text-align: left;
    }
    
    .edit-input {
        width: 100%;
    }
}
</style>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
	
	const loggedInUserId = "${user.user_id}";
	
	$(document).ready(function() {
		
		loadComments();
		
		$("#chat_btn").click(function() {
			
			let seller_id = $(this).data("sellerId");
			let buyer_id = $(this).data("buyerId");
			let product_num = $(this).data("productNum");
			
			if(buyer_id == "") {
				alert("로그인이 필요한 서비스입니다.");
				return;
			}else {
				openChatModal(seller_id, buyer_id, product_num);	
			}
		});
		
		
		$("#report_btn").click(function() {
			
			let reported_user_id = $(this).data("reportedUserId");
			let reporter_id = $(this).data("reporterId");
			let product_num = $(this).data("productNum");
			
			if(reporter_id == "") {
				alert("로그인이 필요한 서비스입니다.");
				return;
			}else {
				openReportModal(reported_user_id, reporter_id, product_num);	
			}
		});
		
		
	    $('#addCommentBtn').click(function() {
	    	
	    	let product_num = $(this).data("productNum");
	    	let user_id = $(this).data("userId");
	    	let comment_content = document.getElementById("comment_content").value.trim();
	
	    	if(user_id == "") {
	    		alert("로그인이 필요한 서비스입니다.");
	    		return;
	    	}
	    	
	        if(comment_content === "") {
	            alert("댓글 내용을 입력하세요.");
	            return;
	        }
	
	        $.post('product_comment_insert.go', {product_num:product_num,
	        									 user_id:user_id,
	        									 comment_content:comment_content}, function(response) {
	            $('textarea[name="comment_content"]').val('');
	            loadComments();
	        });
	    });
	
	    $(document).on('click', '.delete-comment-btn', function() {
	        if (!confirm('정말 삭제하시겠습니까?')) return;
	
	        let commentId = $(this).data('id');
	
	        $.post('product_comment_delete.go', { comment_id: commentId }, function(response) {
	            if (response === 'success') {
	                alert('댓글이 삭제되었습니다.');
	                loadComments();
	            } else {
	                alert('삭제 실패');
	            }
	        });
	    });
	    
	    function escapeHtml(text) {
	        return $('<div>').text(text).html();
	    }
	
	    $(document).on('click', '.edit-comment-btn', function () {
	        let commentBox = $(this).closest('.comment-box');
	        let contentDiv = commentBox.find('.comment-content');
	        let originalContent = contentDiv.text(); // 기존 댓글 내용
	        let commentId = $(this).data('id');

	        // 다른 댓글 편집 모드 초기화
	        $('.comment-box').not(commentBox).each(function() {
	            let box = $(this);
	            let div = box.find('.comment-content');
	            let orig = div.data('original-content');
	            if (box.find('.edit-input').length > 0) {
	                div.text(orig || div.text());
	            }
	        });

	        // 이미 편집 중이면 중복 실행 방지
	        if (commentBox.find('.edit-input').length > 0) return;

	        // 원본 내용 저장
	        contentDiv.data('original-content', originalContent);

	        // --- textarea 생성 ---
	        let textarea = $('<textarea>')
	            .addClass('edit-input')
	            .val(originalContent)
	            .css({
	                width: '100%',
	                padding: '10px',
	                borderRadius: '6px',
	                border: '1px solid #ccc',
	                fontSize: '14px',
	                resize: 'vertical',
	                fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
	                marginBottom: '5px',
	                boxSizing: 'border-box'
	            });

	        // --- 버튼 생성 ---
	        let saveBtn = $('<button>').addClass('save-edit-btn').text('저장');
	        let cancelBtn = $('<button>').addClass('cancel-edit-btn').text('취소');

	        // 버튼 wrapper: textarea 아래 오른쪽 끝
	        let btnWrapper = $('<div>').css({
	            display: 'flex',
	            justifyContent: 'flex-end',
	            gap: '5px'
	        }).append(saveBtn, cancelBtn);

	        // textarea + 버튼 wrapper 붙이기
	        contentDiv.empty().append(textarea, btnWrapper);

	        // --- 저장 버튼 ---
	        saveBtn.click(function() {
	            let newContent = textarea.val().trim();
	            if (!newContent) {
	                alert('댓글 내용을 입력하세요.');
	                return;
	            }

	            $.post('product_comment_update.go',
	                { comment_id: commentId, comment_content: newContent },
	                function(response) {
	                    if (response === 'success') {
	                        contentDiv.text(newContent);
	                        alert('댓글이 수정되었습니다.');
	                    } else {
	                        alert('수정 실패');
	                        contentDiv.text(originalContent);
	                    }
	                }
	            );
	        });

	        // --- 취소 버튼 ---
	        cancelBtn.click(function() {
	            contentDiv.text(originalContent);
	        });
	    });

	    
	    function loadComments() {
	    	
	    	const product_sales_num = document.getElementById("product_num").value;

	        $.getJSON('product_comment_list.go', { product_num: product_sales_num }, function(comments) {
	            $('#commentList').empty();
	            $.each(comments, function(index, comment) {
	
	                let date = new Date(comment.comment_date);
	                date.setHours(date.getHours());
	
	                let formattedDate = date.getFullYear() + '-' +
	                    ('0' + (date.getMonth() + 1)).slice(-2) + '-' +
	                    ('0' + date.getDate()).slice(-2) + ' ' +
	                    ('0' + date.getHours()).slice(-2) + ':' +
	                    ('0' + date.getMinutes()).slice(-2) + ':' +
	                    ('0' + date.getSeconds()).slice(-2);
	
	                let $commentBox = $('<div>').addClass('comment-box');
	                $commentBox.append($('<div>').addClass('comment-user').text(comment.user_id));
	                $commentBox.append($('<div>').addClass('comment-content').text(comment.comment_content));
	                $commentBox.append($('<div>').addClass('comment-date').text(formattedDate));
	               
	                if ($.trim(comment.user_id) === $.trim(loggedInUserId)) {
					    let $actions = $('<div>').addClass('comment-actions');
					    let $deleteBtn = $('<button>').text('삭제').addClass('delete-comment-btn').attr('data-id', comment.comment_id);
					    let $editBtn = $('<button>').text('수정').addClass('edit-comment-btn').attr('data-id', comment.comment_id);
					    $actions.append($editBtn).append($deleteBtn);
					    $commentBox.append($actions);
					}

	                $('#commentList').append($commentBox);
	            });
	        });
	    }
	    
	});
	
	let socket;
	
	function openChatModal(seller_id, buyer_id, product_num) {
	    
	    document.getElementById("chat_seller_id").innerText = seller_id;
	    document.getElementById("chat_modal").style.display = "block";

	    function formatDateTime(dateStr) {
	        const date = new Date(dateStr);
	        const yyyy = date.getFullYear();
	        const MM = String(date.getMonth() + 1).padStart(2, '0');
	        const dd = String(date.getDate()).padStart(2, '0');
	        const HH = String(date.getHours()).padStart(2, '0');
	        const mm = String(date.getMinutes()).padStart(2, '0');
	        return yyyy + "-" + MM + "-" + dd + " " + HH + ":" + mm;
	    }
	    
	    $.ajax({
	        url: "/chat/history",
	        method: "GET",
	        data: {
	            seller_id: buyer_id,
	            buyer_id: seller_id,
	            product_num: product_num
	        },
	        success: function(messages) {
	            const chatWindow = document.getElementById("chat_window");
	            chatWindow.innerHTML = "";
	            messages.forEach(function(msg) {
	                const isMe = msg.from_user === buyer_id;
	                const formattedTime = formatDateTime(msg.sent_time);

	                let messageHtml = "<div class='chat-msg " + (isMe ? "me" : "other") + "'>";
	                messageHtml += "<div>" + (isMe ? "" : "<b>" + msg.from_user + ":</b> ") + msg.message + "</div>";
	                messageHtml += "<div class='chat-meta'>" + formattedTime;
	                if (isMe && msg.is_read == 1) {
	                    messageHtml += " · 읽음";
	                }
	                messageHtml += "</div></div>";

	                chatWindow.innerHTML += messageHtml;
	            });
	            chatWindow.scrollTop = chatWindow.scrollHeight;

	            if (socket && socket.readyState === WebSocket.OPEN) {
	                const readPayload = {
	                    type: "read",
	                    opponentId: seller_id,
	                    productNum: product_num
	                };
	                socket.send(JSON.stringify(readPayload));
	            }
	        }
	    });

	    if (!socket || socket.readyState !== WebSocket.OPEN) {
		    socket = new WebSocket("ws://localhost:8282/chat/" + buyer_id);
	
		    socket.onopen = () => {
		        console.log("Connected to chat server.");
		    };
	
		    socket.onmessage = (event) => {
	            const data = JSON.parse(event.data);

	            if (data.type === "chat") {
	                const chatWindow = document.getElementById("chat_window");
	                const now = formatDateTime(new Date());

	                chatWindow.innerHTML += "<div class='chat-msg other'><div><b>"+data.from+":</b> "+data.message+"</div><div class='chat-meta'>"+now+"</div></div>";
	                chatWindow.scrollTop = chatWindow.scrollHeight;
	            } else if (data.type === "read_ack") {
	                $('#chat_window .chat-msg.me .chat-meta').each(function() {
	                    if (!$(this).text().includes('읽음')) {
	                        $(this).append(' · 읽음');
	                    }
	                });
	            }
	        };
	
		    socket.onerror = (error) => console.error("WebSocket error:", error);
	    }
	    
	    document.getElementById('send_btn').addEventListener('click', () => {
	        const input = document.getElementById('chat_input');
	        const message = input.value;
	        if (message && socket && socket.readyState === WebSocket.OPEN) {

	            const payload = {
	                type: "chat",
	                from: buyer_id,
	                to: seller_id,
	                message: message,
	                product_num: product_num
	            };

	            socket.send(JSON.stringify(payload));

	            const chatWindow = document.getElementById("chat_window");
	            const now = formatDateTime(new Date());

	            chatWindow.innerHTML += "<div class='chat-msg me'><div>"+message+"</div><div class='chat-meta'>"+now+"</div></div>";
	            chatWindow.scrollTop = chatWindow.scrollHeight;

	            input.value = "";
	        }
	    });
	    
	    document.getElementById("chat_input").addEventListener("keydown", function(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                document.getElementById("send_btn").click();
            }
        });
	}

	function closeChatModal() {
	    document.getElementById("chat_modal").style.display = "none";
	    if (socket) {
	        socket.close();
	        socket = null;
	    }
	}
	
	window.sendMessage = function() {
	    const input = document.getElementById("chat_input");
	    const message = input.value;
	    if (message && socket && socket.readyState === WebSocket.OPEN) {
	        socket.send(message);
	        input.value = "";
	    }
	};
	
	function openReportModal(reported_user_id, reporter_id, product_num) {
		
		document.getElementById("report_modal").style.display = "block";
		
		$(document).on('change', 'input[name="report_reason"]', function() {
			const selectedValue = $(this).val();

			if (selectedValue === "other_reason") {
				$('#report_reason').show();
			} else {
				$('#report_reason').hide();
			}
		});
		
		$('#report_table #submit_report_btn').off('click').on('click', function() {
	    	const selectedReason = $('input[name="report_reason"]:checked').val();
	    	let finalReason = selectedReason;

	    	if (selectedReason === "other_reason") {
	    		const customReason = $('#report_reason_text').val().trim();
	    		if (!customReason) {
	    			alert("신고 사유를 입력해주세요.");
	    			return;
	    		}
	    		finalReason = customReason;
	    	}

	    	$.ajax({
	    	    url: "report.go",
	    	    method: "GET",
	    	    data: {
	    	        product_num: product_num,
	    	        reporter_id: reporter_id,
	    	        reported_user_id: reported_user_id,
	    	        report_reason: finalReason,
	    	    },
	    	    success: function(res) {
	    	        if (res === "report") {
	    	            alert("신고가 접수되었습니다.");
	    	            closeReportModal();
	    	            
	    	        }else if(res === "already") {
	    	        	alert("이미 신고한 판매글입니다.");
	    	        	closeReportModal();
	    	        	
	    	        }else {
	    	            alert("신고에 실패했습니다. 다시 시도해주세요.");
	    	            closeReportModal();
	    	        }
	    	    },
	    	    error: function(xhr, status, error) {
	    	        alert("신고 처리 중 오류가 발생하였습니다. 다시 시도해주세요.");
	    	    }
	    	});

	    });

	}
	
	
	function closeReportModal() {
		document.getElementById("report_modal").style.display = "none";
		document.getElementById("report_reason_text").value = "";
	}

	
</script>

<head>
    <title>상품 상세</title>
</head>
<body>
	<jsp:include page="include/header.jsp" />

	<!-- 상품 정보 -->
	<input type="hidden" id="product_num" value="${product.product_num}">
	<c:set var="imgList" value="${fn:split(product.product_img, ',')}" />
	
	<div class="product-container">
	    <img class="product-img" src="<%=request.getContextPath() %>resources/upload/${imgList[0]}" alt="상품 이미지">
	    <div class="product-info">
	        <h2>${product.product_name}</h2>
	        <p><b>가격 :</b>
	            <c:choose>
	                <c:when test="${product.sales_price == 0}">무료나눔</c:when>
	                <c:otherwise><fmt:formatNumber value="${product.sales_price}"/> 원</c:otherwise>
	            </c:choose>
	        </p>
	        <p><b>지역 :</b> ${product.sales_area}</p>
	        <p><b>등록일 :</b> <fmt:formatDate value="${product.product_date}" pattern="yyyy-MM-dd"/></p>
	        <p><b>판매자 :</b> ${product.user_id}</p>
	        <p><b>조회수 :</b> ${product.product_hits}</p>
	
	        <div style="display:flex; gap:10px; margin-top:10px;">
	            <button type="button" id="chat_btn" data-seller-id="${product.user_id}" data-buyer-id="${sessionScope.user.user_id}" data-product-num="${product.product_num}">채팅</button>
	            <button type="button" id="report_btn" data-reported-user-id="${product.user_id}" data-reporter-id="${sessionScope.user.user_id}" data-product-num="${product.product_num}">🚨신고하기</button>
	        </div>
	    </div>
	</div>
	
	<!-- 댓글 -->
	<h3 class="comment-title">댓글</h3>
	<form id="commentForm">
	    <textarea id="comment_content" name="comment_content" rows="3" maxlength="200" placeholder="댓글을 입력하세요."></textarea>
	    <button type="button" id="addCommentBtn" data-product-num="${product.product_num}" data-user-id="${sessionScope.user.user_id}">댓글 등록</button>
	</form>
	<div id="commentList"></div>
	
	<jsp:include page="include/footer.jsp" />
	
	<!-- 채팅 모달 -->
	<div id="chat_modal" style="display:none;">
	    <div id="chat_room">
	        <div class="close_btn" onclick="closeChatModal()">&times;</div>
	        <p id="chat_header"><b>상대방:</b> <span id="chat_seller_id"></span></p>
	        <div id="chat_window" style="height:200px; overflow:auto; border:1px solid #ccc; padding:10px; margin-bottom:10px;"></div>
	        <input type="text" id="chat_input" placeholder="메시지를 입력하세요" style="width:85%;">
	        <button id="send_btn">보내기</button>
	    </div>
	</div>
	
	<!-- 신고 모달 -->
	<div id="report_modal" style="display:none;">
	    <div id="report_table">
	        <div class="close_btn" onclick="closeReportModal()">&times;</div>
	        <div>
	            <label><input type="radio" name="report_reason" value="광고/홍보 목적의 게시글" checked> 광고/홍보 목적의 게시글</label><br>
	            <label><input type="radio" name="report_reason" value="불법 또는 위조 상품 판매"> 불법 또는 위조 상품 판매</label><br>
	            <label><input type="radio" name="report_reason" value="허위 또는 오해의 소지가 있는 정보"> 허위 또는 오해의 소지가 있는 정보</label><br>
	            <label><input type="radio" name="report_reason" value="사기 또는 부정 거래 의심"> 사기 또는 부정 거래 의심</label><br>
	            <label><input type="radio" name="report_reason" value="욕설, 혐오 등 부적절한 내용 포함"> 욕설, 혐오 등 부적절한 내용 포함</label><br>
	            <label><input type="radio" name="report_reason" value="other_reason"> 기타 사유(직접 작성)</label>
	        </div>
	        <div id="report_reason" style="display:none; margin-top: 10px;">
	            <textarea id="report_reason_text" rows="3" maxlength="100" placeholder="신고 사유를 입력하세요. (최대 100자)"></textarea>
	        </div>
	        <br>
	        <div align="center">
	            <button type="button" id="submit_report_btn">🚨신고하기</button>
	        </div>
	    </div>
	</div>

</body>
</html>
